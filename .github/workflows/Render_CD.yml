name: Render CD

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    services:
      mailhog:
        image: mailhog/mailhog:latest
        ports:
          - 1025:1025
    strategy:
      matrix:
        java-version: [21]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java-version }}
          cache: maven

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ matrix.java-version }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-${{ matrix.java-version }}-

      - name: Wait for MailHog to be ready
        run: |
          echo "Waiting a few seconds for MailHog..."
          sleep 5

      - name: Run Maven tests
        working-directory: .
        run: |
          mvn -B -V clean test
        env:
          MAVEN_OPTS: -Xmx2G

      - name: Upload test reports (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            target/surefire-reports/**
            target/failsafe-reports/**

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Render deploy hook
        env:
          RENDER_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_HOOK" ]; then
            echo "RENDER_DEPLOY_HOOK_URL secret is not set"; exit 1;
          fi
          echo "Calling Render deploy webhook..."
          status=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$RENDER_HOOK") || true
          echo "HTTP status: $status"
          if [ "$status" -ge 200 ] && [ "$status" -lt 300 ]; then
            echo "Render deploy webhook triggered successfully.";
          else
            echo "Render deploy webhook failed with status $status"; exit 1;
          fi
